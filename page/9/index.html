<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PingFang SC:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhangruochi.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="RUOCHI.AI">
<meta property="og:url" content="https://zhangruochi.com/page/9/index.html">
<meta property="og:site_name" content="RUOCHI.AI">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ruochi Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zhangruochi.com/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>RUOCHI.AI</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">RUOCHI.AI</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Tensorflow-input-pipeline/2020/02/20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tensorflow-input-pipeline/2020/02/20/" class="post-title-link" itemprop="url">Tensorflow input pipeline</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-20 02:16:41" itemprop="dateCreated datePublished" datetime="2020-02-20T02:16:41+08:00">2020-02-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-14 07:22:10" itemprop="dateModified" datetime="2020-04-14T07:22:10+08:00">2020-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI-Workflow/" itemprop="url" rel="index"><span itemprop="name">AI Workflow</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI-Workflow/Pipeline/" itemprop="url" rel="index"><span itemprop="name">Pipeline</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tensorflow-input-pipeline/2020/02/20/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tensorflow-input-pipeline/2020/02/20/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="classify-structured-data">Classify Structured Data</h1>
<h2 id="import-tensorflow-and-other-libraries">Import TensorFlow and Other Libraries</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tensorflow.keras <span class="keyword">import</span> layers</span><br><span class="line"><span class="keyword">from</span> tensorflow <span class="keyword">import</span> feature_column</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getcwd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br></pre></td></tr></table></figure>
<h2 id="use-pandas-to-create-a-dataframe">Use Pandas to Create a Dataframe</h2>
<p><a target="_blank" rel="noopener" href="https://pandas.pydata.org/">Pandas</a> is a Python library with many helpful utilities for loading and working with structured data. We will use Pandas to download the dataset and load it into a dataframe.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filePath = <span class="string">f&quot;<span class="subst">&#123;getcwd()&#125;</span>/../tmp2/heart.csv&quot;</span></span><br><span class="line">dataframe = pd.read_csv(filePath)</span><br><span class="line">dataframe.head()</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
age
</th>
<th>
sex
</th>
<th>
cp
</th>
<th>
trestbps
</th>
<th>
chol
</th>
<th>
fbs
</th>
<th>
restecg
</th>
<th>
thalach
</th>
<th>
exang
</th>
<th>
oldpeak
</th>
<th>
slope
</th>
<th>
ca
</th>
<th>
thal
</th>
<th>
target
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
63
</td>
<td>
1
</td>
<td>
1
</td>
<td>
145
</td>
<td>
233
</td>
<td>
1
</td>
<td>
2
</td>
<td>
150
</td>
<td>
0
</td>
<td>
2.3
</td>
<td>
3
</td>
<td>
0
</td>
<td>
fixed
</td>
<td>
0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
67
</td>
<td>
1
</td>
<td>
4
</td>
<td>
160
</td>
<td>
286
</td>
<td>
0
</td>
<td>
2
</td>
<td>
108
</td>
<td>
1
</td>
<td>
1.5
</td>
<td>
2
</td>
<td>
3
</td>
<td>
normal
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2
</th>
<td>
67
</td>
<td>
1
</td>
<td>
4
</td>
<td>
120
</td>
<td>
229
</td>
<td>
0
</td>
<td>
2
</td>
<td>
129
</td>
<td>
1
</td>
<td>
2.6
</td>
<td>
2
</td>
<td>
2
</td>
<td>
reversible
</td>
<td>
0
</td>
</tr>
<tr>
<th>
3
</th>
<td>
37
</td>
<td>
1
</td>
<td>
3
</td>
<td>
130
</td>
<td>
250
</td>
<td>
0
</td>
<td>
0
</td>
<td>
187
</td>
<td>
0
</td>
<td>
3.5
</td>
<td>
3
</td>
<td>
0
</td>
<td>
normal
</td>
<td>
0
</td>
</tr>
<tr>
<th>
4
</th>
<td>
41
</td>
<td>
0
</td>
<td>
2
</td>
<td>
130
</td>
<td>
204
</td>
<td>
0
</td>
<td>
2
</td>
<td>
172
</td>
<td>
0
</td>
<td>
1.4
</td>
<td>
1
</td>
<td>
0
</td>
<td>
normal
</td>
<td>
0
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="split-the-dataframe-into-train-validation-and-test-sets">Split the Dataframe Into Train, Validation, and Test Sets</h2>
<p>The dataset we downloaded was a single CSV file. We will split this into train, validation, and test sets.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train, test = train_test_split(dataframe, test_size=<span class="number">0.2</span>)</span><br><span class="line">train, val = train_test_split(train, test_size=<span class="number">0.2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(train), <span class="string">&#x27;train examples&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(val), <span class="string">&#x27;validation examples&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(test), <span class="string">&#x27;test examples&#x27;</span>)</span><br></pre></td></tr></table></figure>
<pre><code>193 train examples
49 validation examples
61 test examples</code></pre>
<h2 id="create-an-input-pipeline-using-tf.data">Create an Input Pipeline Using <code>tf.data</code></h2>
<p>Next, we will wrap the dataframes with <a target="_blank" rel="noopener" href="https://www.tensorflow.org/guide/datasets">tf.data</a>. This will enable us to use feature columns as a bridge to map from the columns in the Pandas dataframe to features used to train the model. If we were working with a very large CSV file (so large that it does not fit into memory), we would use tf.data to read it from disk directly.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: A utility method to create a tf.data dataset from a Pandas Dataframe.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">df_to_dataset</span>(<span class="params">dataframe, shuffle=<span class="literal">True</span>, batch_size=<span class="number">32</span></span>):</span></span><br><span class="line">    dataframe = dataframe.copy()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Use Pandas dataframe&#x27;s pop method to get the list of targets.</span></span><br><span class="line">    labels = dataframe[<span class="string">&quot;target&quot;</span>].values</span><br><span class="line">    dataframe.drop(<span class="string">&quot;target&quot;</span>, axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Create a tf.data.Dataset from the dataframe and labels.</span></span><br><span class="line">    ds = tf.data.Dataset.from_tensor_slices((<span class="built_in">dict</span>(dataframe),labels))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> shuffle:</span><br><span class="line">        <span class="comment"># Shuffle dataset.</span></span><br><span class="line">        ds = ds.shuffle(<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Batch dataset with specified batch_size parameter.</span></span><br><span class="line">    ds = ds.batch(batch_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ds</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">5</span> <span class="comment"># A small batch sized is used for demonstration purposes</span></span><br><span class="line">train_ds = df_to_dataset(train, batch_size=batch_size)</span><br><span class="line">val_ds = df_to_dataset(val, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br><span class="line">test_ds = df_to_dataset(test, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br></pre></td></tr></table></figure>
<h2 id="understand-the-input-pipeline">Understand the Input Pipeline</h2>
<p>Now that we have created the input pipeline, let's call it to see the format of the data it returns. We have used a small batch size to keep the output readable.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> feature_batch, label_batch <span class="keyword">in</span> train_ds.take(<span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Every feature:&#x27;</span>, <span class="built_in">list</span>(feature_batch.keys()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;A batch of ages:&#x27;</span>, feature_batch[<span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;A batch of targets:&#x27;</span>, label_batch )</span><br></pre></td></tr></table></figure>
<pre><code>Every feature: [&#39;age&#39;, &#39;sex&#39;, &#39;cp&#39;, &#39;trestbps&#39;, &#39;chol&#39;, &#39;fbs&#39;, &#39;restecg&#39;, &#39;thalach&#39;, &#39;exang&#39;, &#39;oldpeak&#39;, &#39;slope&#39;, &#39;ca&#39;, &#39;thal&#39;]
A batch of ages: tf.Tensor([51 63 64 58 57], shape=(5,), dtype=int32)
A batch of targets: tf.Tensor([0 1 0 0 0], shape=(5,), dtype=int64)</code></pre>
<p>We can see that the dataset returns a dictionary of column names (from the dataframe) that map to column values from rows in the dataframe.</p>
<h2 id="create-several-types-of-feature-columns">Create Several Types of Feature Columns</h2>
<p>TensorFlow provides many types of feature columns. In this section, we will create several types of feature columns, and demonstrate how they transform a column from the dataframe.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Try to demonstrate several types of feature columns by getting an example.</span></span><br><span class="line">example_batch = <span class="built_in">next</span>(<span class="built_in">iter</span>(train_ds))[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A utility method to create a feature column and to transform a batch of data.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo</span>(<span class="params">feature_column</span>):</span></span><br><span class="line">    feature_layer = layers.DenseFeatures(feature_column, dtype=<span class="string">&#x27;float64&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(feature_layer(example_batch).numpy())</span><br></pre></td></tr></table></figure>
<h3 id="numeric-columns">Numeric Columns</h3>
<p>The output of a feature column becomes the input to the model (using the demo function defined above, we will be able to see exactly how each column from the dataframe is transformed). A <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/numeric_column">numeric column</a> is the simplest type of column. It is used to represent real valued features.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a numeric feature column out of &#x27;age&#x27; and demo it.</span></span><br><span class="line">age = tf.feature_column.numeric_column(<span class="string">&quot;age&quot;</span>)</span><br><span class="line"></span><br><span class="line">demo(age)</span><br></pre></td></tr></table></figure>
<pre><code>[[51.]
 [58.]
 [63.]
 [64.]
 [60.]]</code></pre>
<p>In the heart disease dataset, most columns from the dataframe are numeric.</p>
<h3 id="bucketized-columns">Bucketized Columns</h3>
<p>Often, you don't want to feed a number directly into the model, but instead split its value into different categories based on numerical ranges. Consider raw data that represents a person's age. Instead of representing age as a numeric column, we could split the age into several buckets using a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/bucketized_column">bucketized column</a>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a bucketized feature column out of &#x27;age&#x27; with</span></span><br><span class="line"><span class="comment"># the following boundaries and demo it.</span></span><br><span class="line">boundaries = [<span class="number">18</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">45</span>, <span class="number">50</span>, <span class="number">55</span>, <span class="number">60</span>, <span class="number">65</span>]</span><br><span class="line"></span><br><span class="line">age_buckets = tf.feature_column.bucketized_column(age, boundaries = boundaries)</span><br><span class="line"></span><br><span class="line">demo(age_buckets)</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0.]]</code></pre>
<p>Notice the one-hot values above describe which age range each row matches.</p>
<h3 id="categorical-columns">Categorical Columns</h3>
<p>In this dataset, thal is represented as a string (e.g. 'fixed', 'normal', or 'reversible'). We cannot feed strings directly to a model. Instead, we must first map them to numeric values. The categorical vocabulary columns provide a way to represent strings as a one-hot vector (much like you have seen above with age buckets).</p>
<p><strong>Note</strong>: You will probably see some warning messages when running some of the code cell below. These warnings have to do with software updates and should not cause any errors or prevent your code from running.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a categorical vocabulary column out of the</span></span><br><span class="line"><span class="comment"># above mentioned categories with the key specified as &#x27;thal&#x27;.</span></span><br><span class="line">thal = tf.feature_column.categorical_column_with_vocabulary_list(</span><br><span class="line">      <span class="string">&#x27;thal&#x27;</span>, [<span class="string">&#x27;fixed&#x27;</span>, <span class="string">&#x27;normal&#x27;</span>, <span class="string">&#x27;reversible&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># EXERCISE: Create an indicator column out of the created categorical column.</span></span><br><span class="line">thal_one_hot = tf.feature_column.indicator_column(thal)</span><br><span class="line"></span><br><span class="line">demo(thal_one_hot)</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 1. 0.]
 [0. 1. 0.]
 [0. 0. 1.]
 [0. 0. 1.]
 [0. 1. 0.]]</code></pre>
<p>The vocabulary can be passed as a list using <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/categorical_column_with_vocabulary_list">categorical_column_with_vocabulary_list</a>, or loaded from a file using <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/categorical_column_with_vocabulary_file">categorical_column_with_vocabulary_file</a>.</p>
<h3 id="embedding-columns">Embedding Columns</h3>
<p>Suppose instead of having just a few possible strings, we have thousands (or more) values per category. For a number of reasons, as the number of categories grow large, it becomes infeasible to train a neural network using one-hot encodings. We can use an embedding column to overcome this limitation. Instead of representing the data as a one-hot vector of many dimensions, an <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/embedding_column">embedding column</a> represents that data as a lower-dimensional, dense vector in which each cell can contain any number, not just 0 or 1. You can tune the size of the embedding with the <code>dimension</code> parameter.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create an embedding column out of the categorical</span></span><br><span class="line"><span class="comment"># vocabulary you just created (thal). Set the size of the </span></span><br><span class="line"><span class="comment"># embedding to 8, by using the dimension parameter.</span></span><br><span class="line"></span><br><span class="line">thal_embedding = tf.feature_column.embedding_column(thal, dimension=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">demo(thal_embedding)</span><br></pre></td></tr></table></figure>
<pre><code>[[-1.4254066e-01 -1.0374661e-01  3.4352791e-01 -3.3996427e-01
  -3.2193713e-02 -1.8381193e-01 -1.8051244e-01  3.2638407e-01]
 [-1.4254066e-01 -1.0374661e-01  3.4352791e-01 -3.3996427e-01
  -3.2193713e-02 -1.8381193e-01 -1.8051244e-01  3.2638407e-01]
 [-6.5549983e-05  2.7680036e-01  4.1849682e-01  5.3418136e-01
  -1.6281548e-01  2.5406811e-01  8.8969752e-02  1.8004593e-01]
 [-6.5549983e-05  2.7680036e-01  4.1849682e-01  5.3418136e-01
  -1.6281548e-01  2.5406811e-01  8.8969752e-02  1.8004593e-01]
 [-1.4254066e-01 -1.0374661e-01  3.4352791e-01 -3.3996427e-01
  -3.2193713e-02 -1.8381193e-01 -1.8051244e-01  3.2638407e-01]]</code></pre>
<h3 id="hashed-feature-columns">Hashed Feature Columns</h3>
<p>Another way to represent a categorical column with a large number of values is to use a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/categorical_column_with_hash_bucket">categorical_column_with_hash_bucket</a>. This feature column calculates a hash value of the input, then selects one of the <code>hash_bucket_size</code> buckets to encode a string. When using this column, you do not need to provide the vocabulary, and you can choose to make the number of hash buckets significantly smaller than the number of actual categories to save space.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a hashed feature column with &#x27;thal&#x27; as the key and </span></span><br><span class="line"><span class="comment"># 1000 hash buckets.</span></span><br><span class="line">thal_hashed = tf.feature_column.categorical_column_with_hash_bucket(</span><br><span class="line">      <span class="string">&#x27;thal&#x27;</span>, hash_bucket_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">demo(feature_column.indicator_column(thal_hashed))</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]]</code></pre>
<h3 id="crossed-feature-columns">Crossed Feature Columns</h3>
<p>Combining features into a single feature, better known as <a target="_blank" rel="noopener" href="https://developers.google.com/machine-learning/glossary/#feature_cross">feature crosses</a>, enables a model to learn separate weights for each combination of features. Here, we will create a new feature that is the cross of age and thal. Note that <code>crossed_column</code> does not build the full table of all possible combinations (which could be very large). Instead, it is backed by a <code>hashed_column</code>, so you can choose how large the table is.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a crossed column using the bucketized column (age_buckets),</span></span><br><span class="line"><span class="comment"># the categorical vocabulary column (thal) previously created, and 1000 hash buckets.</span></span><br><span class="line">crossed_feature = tf.feature_column.crossed_column([age_buckets, thal], hash_bucket_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">demo(feature_column.indicator_column(crossed_feature))</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]]</code></pre>
<h2 id="choose-which-columns-to-use">Choose Which Columns to Use</h2>
<p>We have seen how to use several types of feature columns. Now we will use them to train a model. The goal of this exercise is to show you the complete code needed to work with feature columns. We have selected a few columns to train our model below arbitrarily.</p>
<p>If your aim is to build an accurate model, try a larger dataset of your own, and think carefully about which features are the most meaningful to include, and how they should be represented.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataframe.dtypes</span><br></pre></td></tr></table></figure>
<pre><code>age           int64
sex           int64
cp            int64
trestbps      int64
chol          int64
fbs           int64
restecg       int64
thalach       int64
exang         int64
oldpeak     float64
slope         int64
ca            int64
thal         object
target        int64
dtype: object</code></pre>
<p>You can use the above list of column datatypes to map the appropriate feature column to every column in the dataframe.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Fill in the missing code below</span></span><br><span class="line">feature_columns = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Numeric Cols.</span></span><br><span class="line"><span class="comment"># Create a list of numeric columns. Use the following list of columns</span></span><br><span class="line"><span class="comment"># that have a numeric datatype: [&#x27;age&#x27;, &#x27;trestbps&#x27;, &#x27;chol&#x27;, &#x27;thalach&#x27;, &#x27;oldpeak&#x27;, &#x27;slope&#x27;, &#x27;ca&#x27;].</span></span><br><span class="line">numeric_columns = [<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;trestbps&#x27;</span>, <span class="string">&#x27;chol&#x27;</span>, <span class="string">&#x27;thalach&#x27;</span>, <span class="string">&#x27;oldpeak&#x27;</span>, <span class="string">&#x27;slope&#x27;</span>, <span class="string">&#x27;ca&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> header <span class="keyword">in</span> numeric_columns:</span><br><span class="line">    <span class="comment"># Create a numeric feature column  out of the header.</span></span><br><span class="line">    numeric_feature_column = tf.feature_column.numeric_column(header)</span><br><span class="line">    </span><br><span class="line">    feature_columns.append(numeric_feature_column)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bucketized Cols.</span></span><br><span class="line"><span class="comment"># Create a bucketized feature column out of the age column (numeric column)</span></span><br><span class="line"><span class="comment"># that you&#x27;ve already created. Use the following boundaries:</span></span><br><span class="line"><span class="comment"># [18, 25, 30, 35, 40, 45, 50, 55, 60, 65]</span></span><br><span class="line">age_buckets = tf.feature_column.bucketized_column(age, boundaries = [<span class="number">18</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">45</span>, <span class="number">50</span>, <span class="number">55</span>, <span class="number">60</span>, <span class="number">65</span>] )</span><br><span class="line"></span><br><span class="line">feature_columns.append(age_buckets)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Indicator Cols.</span></span><br><span class="line"><span class="comment"># Create a categorical vocabulary column out of the categories</span></span><br><span class="line"><span class="comment"># [&#x27;fixed&#x27;, &#x27;normal&#x27;, &#x27;reversible&#x27;] with the key specified as &#x27;thal&#x27;.</span></span><br><span class="line">thal = feature_column.categorical_column_with_vocabulary_list(</span><br><span class="line">      <span class="string">&#x27;thal&#x27;</span>, [<span class="string">&#x27;fixed&#x27;</span>, <span class="string">&#x27;normal&#x27;</span>, <span class="string">&#x27;reversible&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an indicator column out of the created thal categorical column</span></span><br><span class="line">thal_one_hot = feature_column.indicator_column(thal)</span><br><span class="line"></span><br><span class="line">feature_columns.append(thal_one_hot)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Embedding Cols.</span></span><br><span class="line"><span class="comment"># Create an embedding column out of the categorical vocabulary you</span></span><br><span class="line"><span class="comment"># just created (thal). Set the size of the embedding to 8, by using</span></span><br><span class="line"><span class="comment"># the dimension parameter.</span></span><br><span class="line">thal_embedding = tf.feature_column.embedding_column(thal, dimension=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">feature_columns.append(thal_embedding)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Crossed Cols.</span></span><br><span class="line"><span class="comment"># Create a crossed column using the bucketized column (age_buckets),</span></span><br><span class="line"><span class="comment"># the categorical vocabulary column (thal) previously created, and 1000 hash buckets.</span></span><br><span class="line">crossed_feature = feature_column.crossed_column([age_buckets, thal], hash_bucket_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an indicator column out of the crossed column created above to one-hot encode it.</span></span><br><span class="line">crossed_feature = feature_column.indicator_column(crossed_feature)</span><br><span class="line"></span><br><span class="line">feature_columns.append(crossed_feature)</span><br></pre></td></tr></table></figure>
<h3 id="create-a-feature-layer">Create a Feature Layer</h3>
<p>Now that we have defined our feature columns, we will use a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/keras/layers/DenseFeatures">DenseFeatures</a> layer to input them to our Keras model.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a Keras DenseFeatures layer and pass the feature_columns you just created.</span></span><br><span class="line">feature_layer = tf.keras.layers.DenseFeatures(feature_columns)</span><br></pre></td></tr></table></figure>
<p>Earlier, we used a small batch size to demonstrate how feature columns worked. We create a new input pipeline with a larger batch size.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">32</span></span><br><span class="line">train_ds = df_to_dataset(train, batch_size=batch_size)</span><br><span class="line">val_ds = df_to_dataset(val, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br><span class="line">test_ds = df_to_dataset(test, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br></pre></td></tr></table></figure>
<h2 id="create-compile-and-train-the-model">Create, Compile, and Train the Model</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">model = tf.keras.Sequential([</span><br><span class="line">        feature_layer,</span><br><span class="line">        layers.Dense(<span class="number">128</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">        layers.Dense(<span class="number">128</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">        layers.Dense(<span class="number">1</span>, activation=<span class="string">&#x27;sigmoid&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>,</span><br><span class="line">              loss=<span class="string">&#x27;binary_crossentropy&#x27;</span>,</span><br><span class="line">              metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line"></span><br><span class="line">model.fit(train_ds,</span><br><span class="line">          validation_data=val_ds,</span><br><span class="line">          epochs=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<pre><code>Epoch 1/100
7/7 [==============================] - 4s 609ms/step - loss: 1.5455 - accuracy: 0.6321 - val_loss: 0.0000e+00 - val_accuracy: 0.0000e+00
Epoch 2/100
7/7 [==============================] - 0s 45ms/step - loss: 1.6424 - accuracy: 0.5803 - val_loss: 1.7392 - val_accuracy: 0.7143
Epoch 3/100
7/7 [==============================] - 0s 44ms/step - loss: 1.2255 - accuracy: 0.6995 - val_loss: 0.7653 - val_accuracy: 0.5714
Epoch 4/100
7/7 [==============================] - 0s 44ms/step - loss: 0.7326 - accuracy: 0.6891 - val_loss: 0.5689 - val_accuracy: 0.6939
Epoch 5/100
7/7 [==============================] - 0s 43ms/step - loss: 0.5230 - accuracy: 0.7358 - val_loss: 0.5406 - val_accuracy: 0.7143
Epoch 6/100
7/7 [==============================] - 0s 44ms/step - loss: 0.4348 - accuracy: 0.8083 - val_loss: 0.5609 - val_accuracy: 0.7143
Epoch 7/100
7/7 [==============================] - 0s 56ms/step - loss: 0.4592 - accuracy: 0.7824 - val_loss: 0.5710 - val_accuracy: 0.7347
Epoch 8/100
7/7 [==============================] - 0s 45ms/step - loss: 0.4996 - accuracy: 0.7461 - val_loss: 0.5585 - val_accuracy: 0.7143
Epoch 9/100
7/7 [==============================] - 0s 44ms/step - loss: 0.4389 - accuracy: 0.7927 - val_loss: 0.5297 - val_accuracy: 0.6735
Epoch 10/100
7/7 [==============================] - 0s 55ms/step - loss: 0.3914 - accuracy: 0.8446 - val_loss: 0.5216 - val_accuracy: 0.6531
Epoch 11/100
7/7 [==============================] - 0s 45ms/step - loss: 0.4022 - accuracy: 0.7979 - val_loss: 0.5331 - val_accuracy: 0.7347
Epoch 12/100
7/7 [==============================] - 0s 54ms/step - loss: 0.3811 - accuracy: 0.8238 - val_loss: 0.6522 - val_accuracy: 0.6735
Epoch 13/100
7/7 [==============================] - 0s 44ms/step - loss: 0.4173 - accuracy: 0.7927 - val_loss: 0.5219 - val_accuracy: 0.7347
Epoch 14/100
7/7 [==============================] - 0s 44ms/step - loss: 0.4235 - accuracy: 0.7513 - val_loss: 0.5027 - val_accuracy: 0.6531
Epoch 15/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3789 - accuracy: 0.7979 - val_loss: 0.7249 - val_accuracy: 0.6531
Epoch 16/100
7/7 [==============================] - 0s 45ms/step - loss: 0.3972 - accuracy: 0.8342 - val_loss: 0.4830 - val_accuracy: 0.6939
Epoch 17/100
7/7 [==============================] - 0s 55ms/step - loss: 0.3339 - accuracy: 0.8601 - val_loss: 0.4912 - val_accuracy: 0.6531
Epoch 18/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3555 - accuracy: 0.7927 - val_loss: 0.6399 - val_accuracy: 0.6939
Epoch 19/100
7/7 [==============================] - 0s 43ms/step - loss: 0.3531 - accuracy: 0.8601 - val_loss: 0.5526 - val_accuracy: 0.6735
Epoch 20/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3810 - accuracy: 0.7876 - val_loss: 0.5751 - val_accuracy: 0.7143
Epoch 21/100
7/7 [==============================] - 0s 56ms/step - loss: 0.3409 - accuracy: 0.8549 - val_loss: 0.5524 - val_accuracy: 0.7551
Epoch 22/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3167 - accuracy: 0.8756 - val_loss: 0.6607 - val_accuracy: 0.7143
Epoch 23/100
7/7 [==============================] - 0s 45ms/step - loss: 0.3732 - accuracy: 0.8601 - val_loss: 0.5993 - val_accuracy: 0.6939
Epoch 24/100
7/7 [==============================] - 0s 55ms/step - loss: 0.3918 - accuracy: 0.7979 - val_loss: 0.5646 - val_accuracy: 0.6735
Epoch 25/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3624 - accuracy: 0.8187 - val_loss: 0.7324 - val_accuracy: 0.6735
Epoch 26/100
7/7 [==============================] - 0s 56ms/step - loss: 0.3531 - accuracy: 0.8446 - val_loss: 0.4501 - val_accuracy: 0.6939
Epoch 27/100
7/7 [==============================] - 0s 45ms/step - loss: 0.3164 - accuracy: 0.8653 - val_loss: 0.4770 - val_accuracy: 0.6735
Epoch 28/100
7/7 [==============================] - 0s 55ms/step - loss: 0.3557 - accuracy: 0.8290 - val_loss: 0.5188 - val_accuracy: 0.7551
Epoch 29/100
7/7 [==============================] - 0s 45ms/step - loss: 0.3193 - accuracy: 0.8446 - val_loss: 0.5949 - val_accuracy: 0.7347
Epoch 30/100
7/7 [==============================] - 0s 55ms/step - loss: 0.3049 - accuracy: 0.8601 - val_loss: 0.5904 - val_accuracy: 0.7347
Epoch 31/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3150 - accuracy: 0.8705 - val_loss: 0.4901 - val_accuracy: 0.6531
Epoch 32/100
7/7 [==============================] - 0s 55ms/step - loss: 0.3223 - accuracy: 0.8446 - val_loss: 0.5034 - val_accuracy: 0.6939
Epoch 33/100
7/7 [==============================] - 0s 43ms/step - loss: 0.3178 - accuracy: 0.8394 - val_loss: 0.6359 - val_accuracy: 0.7347
Epoch 34/100
7/7 [==============================] - 0s 43ms/step - loss: 0.3041 - accuracy: 0.8549 - val_loss: 0.5558 - val_accuracy: 0.7551
Epoch 35/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2853 - accuracy: 0.8808 - val_loss: 0.5089 - val_accuracy: 0.6939
Epoch 36/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2905 - accuracy: 0.8653 - val_loss: 0.5989 - val_accuracy: 0.7347
Epoch 37/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2885 - accuracy: 0.8705 - val_loss: 0.5644 - val_accuracy: 0.7551
Epoch 38/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2890 - accuracy: 0.8601 - val_loss: 0.5590 - val_accuracy: 0.7755
Epoch 39/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2792 - accuracy: 0.8808 - val_loss: 0.4820 - val_accuracy: 0.7551
Epoch 40/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2781 - accuracy: 0.8653 - val_loss: 0.4974 - val_accuracy: 0.7551
Epoch 41/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2873 - accuracy: 0.8705 - val_loss: 0.5550 - val_accuracy: 0.7551
Epoch 42/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2737 - accuracy: 0.8808 - val_loss: 0.5356 - val_accuracy: 0.7347
Epoch 43/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2677 - accuracy: 0.8860 - val_loss: 0.5071 - val_accuracy: 0.7551
Epoch 44/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2794 - accuracy: 0.8756 - val_loss: 0.5320 - val_accuracy: 0.6939
Epoch 45/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2932 - accuracy: 0.8394 - val_loss: 0.5533 - val_accuracy: 0.7755
Epoch 46/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2750 - accuracy: 0.8705 - val_loss: 0.5723 - val_accuracy: 0.7347
Epoch 47/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2694 - accuracy: 0.8808 - val_loss: 0.5347 - val_accuracy: 0.7551
Epoch 48/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2632 - accuracy: 0.8912 - val_loss: 0.5369 - val_accuracy: 0.7755
Epoch 49/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2677 - accuracy: 0.8860 - val_loss: 0.5837 - val_accuracy: 0.7143
Epoch 50/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2635 - accuracy: 0.8808 - val_loss: 0.5337 - val_accuracy: 0.7755
Epoch 51/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2592 - accuracy: 0.8912 - val_loss: 0.5533 - val_accuracy: 0.7755
Epoch 52/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2536 - accuracy: 0.8912 - val_loss: 0.5743 - val_accuracy: 0.7347
Epoch 53/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2511 - accuracy: 0.9016 - val_loss: 0.5451 - val_accuracy: 0.7551
Epoch 54/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2650 - accuracy: 0.8860 - val_loss: 0.5864 - val_accuracy: 0.6531
Epoch 55/100
7/7 [==============================] - 0s 45ms/step - loss: 0.3354 - accuracy: 0.8290 - val_loss: 0.5772 - val_accuracy: 0.7347
Epoch 56/100
7/7 [==============================] - 0s 54ms/step - loss: 0.2759 - accuracy: 0.8653 - val_loss: 0.5857 - val_accuracy: 0.7347
Epoch 57/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2522 - accuracy: 0.8860 - val_loss: 0.5930 - val_accuracy: 0.7347
Epoch 58/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2488 - accuracy: 0.8808 - val_loss: 0.5814 - val_accuracy: 0.7551
Epoch 59/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2428 - accuracy: 0.8964 - val_loss: 0.5805 - val_accuracy: 0.7551
Epoch 60/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2555 - accuracy: 0.8912 - val_loss: 0.5903 - val_accuracy: 0.7347
Epoch 61/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2391 - accuracy: 0.9016 - val_loss: 0.5721 - val_accuracy: 0.7755
Epoch 62/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2423 - accuracy: 0.8860 - val_loss: 0.5911 - val_accuracy: 0.7551
Epoch 63/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2450 - accuracy: 0.8756 - val_loss: 0.5845 - val_accuracy: 0.7755
Epoch 64/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2447 - accuracy: 0.8912 - val_loss: 0.5883 - val_accuracy: 0.7551
Epoch 65/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2386 - accuracy: 0.8964 - val_loss: 0.6093 - val_accuracy: 0.7551
Epoch 66/100
7/7 [==============================] - 0s 56ms/step - loss: 0.2278 - accuracy: 0.9067 - val_loss: 0.6654 - val_accuracy: 0.7347
Epoch 67/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2474 - accuracy: 0.8912 - val_loss: 0.6545 - val_accuracy: 0.7143
Epoch 68/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2509 - accuracy: 0.8808 - val_loss: 0.6298 - val_accuracy: 0.6735
Epoch 69/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2931 - accuracy: 0.8549 - val_loss: 0.6237 - val_accuracy: 0.7347
Epoch 70/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2653 - accuracy: 0.8808 - val_loss: 0.6296 - val_accuracy: 0.7143
Epoch 71/100
7/7 [==============================] - 0s 43ms/step - loss: 0.2649 - accuracy: 0.8549 - val_loss: 0.5915 - val_accuracy: 0.6531
Epoch 72/100
7/7 [==============================] - 0s 44ms/step - loss: 0.3141 - accuracy: 0.8394 - val_loss: 0.6017 - val_accuracy: 0.7755
Epoch 73/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2557 - accuracy: 0.8756 - val_loss: 0.6444 - val_accuracy: 0.7347
Epoch 74/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2220 - accuracy: 0.9067 - val_loss: 0.6380 - val_accuracy: 0.7347
Epoch 75/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2209 - accuracy: 0.9016 - val_loss: 0.6977 - val_accuracy: 0.7347
Epoch 76/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2318 - accuracy: 0.8964 - val_loss: 0.6422 - val_accuracy: 0.7347
Epoch 77/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2183 - accuracy: 0.9067 - val_loss: 0.6183 - val_accuracy: 0.7143
Epoch 78/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2304 - accuracy: 0.8860 - val_loss: 0.6522 - val_accuracy: 0.7143
Epoch 79/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2338 - accuracy: 0.8756 - val_loss: 0.5959 - val_accuracy: 0.7551
Epoch 80/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2250 - accuracy: 0.8964 - val_loss: 0.6232 - val_accuracy: 0.7551
Epoch 81/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2275 - accuracy: 0.8912 - val_loss: 0.6500 - val_accuracy: 0.7551
Epoch 82/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2053 - accuracy: 0.9016 - val_loss: 0.6249 - val_accuracy: 0.7347
Epoch 83/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2250 - accuracy: 0.8964 - val_loss: 0.6744 - val_accuracy: 0.7347
Epoch 84/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2109 - accuracy: 0.9067 - val_loss: 0.7039 - val_accuracy: 0.7347
Epoch 85/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2171 - accuracy: 0.9016 - val_loss: 0.6693 - val_accuracy: 0.7347
Epoch 86/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2187 - accuracy: 0.9067 - val_loss: 0.6765 - val_accuracy: 0.7143
Epoch 87/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2225 - accuracy: 0.9067 - val_loss: 0.6637 - val_accuracy: 0.6939
Epoch 88/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2193 - accuracy: 0.8808 - val_loss: 0.7029 - val_accuracy: 0.6735
Epoch 89/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2644 - accuracy: 0.8653 - val_loss: 0.6829 - val_accuracy: 0.6939
Epoch 90/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2625 - accuracy: 0.8601 - val_loss: 0.6617 - val_accuracy: 0.7347
Epoch 91/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2206 - accuracy: 0.8860 - val_loss: 0.6889 - val_accuracy: 0.7551
Epoch 92/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2090 - accuracy: 0.8964 - val_loss: 0.7322 - val_accuracy: 0.7347
Epoch 93/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2016 - accuracy: 0.9119 - val_loss: 0.7244 - val_accuracy: 0.7347
Epoch 94/100
7/7 [==============================] - 0s 55ms/step - loss: 0.1933 - accuracy: 0.9067 - val_loss: 0.6788 - val_accuracy: 0.7347
Epoch 95/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2002 - accuracy: 0.9171 - val_loss: 0.6849 - val_accuracy: 0.7143
Epoch 96/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2138 - accuracy: 0.8964 - val_loss: 0.7610 - val_accuracy: 0.6939
Epoch 97/100
7/7 [==============================] - 0s 45ms/step - loss: 0.2225 - accuracy: 0.8912 - val_loss: 0.6998 - val_accuracy: 0.6939
Epoch 98/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2089 - accuracy: 0.9067 - val_loss: 0.6846 - val_accuracy: 0.7143
Epoch 99/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2043 - accuracy: 0.8964 - val_loss: 0.7292 - val_accuracy: 0.7347
Epoch 100/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2008 - accuracy: 0.9016 - val_loss: 0.7064 - val_accuracy: 0.7143





&lt;tensorflow.python.keras.callbacks.History at 0x7f33184937b8&gt;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loss, accuracy = model.evaluate(test_ds)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy&quot;</span>, accuracy)</span><br></pre></td></tr></table></figure>
<pre><code>2/2 [==============================] - 1s 329ms/step - loss: 0.5511 - accuracy: 0.8197
Accuracy 0.8196721</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/TensorFlow-Data-Service/2020/02/17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/TensorFlow-Data-Service/2020/02/17/" class="post-title-link" itemprop="url">TensorFlow Data Service</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-17 23:58:32" itemprop="dateCreated datePublished" datetime="2020-02-17T23:58:32+08:00">2020-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-25 05:34:49" itemprop="dateModified" datetime="2020-02-25T05:34:49+08:00">2020-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/TensorFlow-Data-Service/2020/02/17/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/TensorFlow-Data-Service/2020/02/17/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="extract---transform---load-etl">Extract - Transform - Load (ETL)</h2>
<center>
<img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="ETL.png" width = "80%" height="80%">
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
ETL Pipeline
</div>
</center>
<p>First, to perform the Extract process we use tfts.load. This handles everything from downloading the raw data to parsing and splitting it, giving us a dataset. Next, we perform the Transform process. In this simple example, our transform process will just consist of shuffling the dataset. Finally, we Load one record by using the take(1) method. In this case, each record consists of an image and its corresponding label. After loading the record we proceed to plot the image and print its corresponding label.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXTRACT</span></span><br><span class="line">dataset = tfds.load(name=<span class="string">&quot;mnist&quot;</span>, split=<span class="string">&quot;train&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TRANSFORM</span></span><br><span class="line">dataset.shuffle(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># LOAD</span></span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> dataset.take(<span class="number">1</span>):</span><br><span class="line">    image = data[<span class="string">&quot;image&quot;</span>].numpy().squeeze()</span><br><span class="line">    label = data[<span class="string">&quot;label&quot;</span>].numpy()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Label: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(label))</span><br><span class="line">    plt.imshow(image, cmap=plt.cm.binary)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<h2 id="us3-api-for-tensorflow-datasets.">US3 API for TensorFlow datasets.</h2>
<center>
<img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="s3.png" width = "80%" height="80%">
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
S3 API
</div>
</center>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\u2022 Using TensorFlow Version:&quot;</span>, tf.__version__)</span><br></pre></td></tr></table></figure>
<p>Before using the new S3 API, we must first find out whether the MNIST dataset implements the new S3 API. In the cell below we indicate that we want to use version <code>3.*.*</code> of the MNIST dataset.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mnist_builder = tfds.builder(<span class="string">&quot;mnist:3.*.*&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mnist_builder.version.implements(tfds.core.Experiment.S3))</span><br></pre></td></tr></table></figure>
<p>We can see that the code above printed <code>True</code>, which means that version <code>3.*.*</code> of the MNIST dataset supports the new S3 API.</p>
<p>Now, let's see how we can use the S3 API to download the MNIST dataset and specify the splits we want use. In the code below we download the <code>train</code> and <code>test</code> splits of the MNIST dataset and then we print their size. We will see that there are 60,000 records in the training set and 10,000 in the test set.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train_ds, test_ds = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=[<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;test&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(train_ds)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(test_ds)))</span><br></pre></td></tr></table></figure>
<p>In the S3 API we can use strings to specify the slicing instructions. For example, in the cell below we will merge the training and test sets by passing the string <code>train+test'</code> to the <code>split</code> argument.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">combined = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=<span class="string">&#x27;train+test&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(combined)))</span><br></pre></td></tr></table></figure>
<p>We can also use Python style list slicers to specify the data we want. For example, we can specify that we want to take the first 10,000 records of the <code>train</code> split with the string <code>'train[:10000]'</code>, as shown below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">first10k = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=<span class="string">&#x27;train[:10000]&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(first10k)))</span><br></pre></td></tr></table></figure>
<p>The S3 API, also allows us to specify the percentage of the data we want to use. For example, we can select the first 20% of the training set with the string <code>'train[:20%]'</code>, as shown below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">first20p = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=<span class="string">&#x27;train[:20%]&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(first20p)))</span><br></pre></td></tr></table></figure>
<p>We can see that <code>first20p</code> contains 12,000 records, which is indeed 20% the total number of records in the training set. Recall that the training set contains 60,000 records.</p>
<p>Because the slices are string-based we can use loops, like the ones shown below, to slice up the dataset and make some pretty complex splits. For example, the loops below create 10 complimentary validation and training sets (each loop returns a list with 5 data sets).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val_ds = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=[<span class="string">&#x27;train[&#123;&#125;%:&#123;&#125;%]&#x27;</span>.<span class="built_in">format</span>(k, k+<span class="number">20</span>) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">100</span>, <span class="number">20</span>)])</span><br><span class="line"></span><br><span class="line">train_ds = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=[<span class="string">&#x27;train[:&#123;&#125;%]+train[&#123;&#125;%:]&#x27;</span>.<span class="built_in">format</span>(k, k+<span class="number">20</span>) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">100</span>, <span class="number">20</span>)])</span><br></pre></td></tr></table></figure>
<p>The S3 API also allows us to compose new datasets by using pieces from different splits. For example, we can create a new dataset from the first 10% of the test set and the last 80% of the training set, as shown below.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">composed_ds = tfds.load(<span class="string">&#x27;mnist:3.*.*&#x27;</span>, split=<span class="string">&#x27;test[:10%]+train[-80%:]&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(composed_ds)))</span><br></pre></td></tr></table></figure>
<h1 id="pipeline-for-classifing-structured-data">Pipeline for Classifing Structured Data</h1>
<h2 id="import-tensorflow-and-other-libraries">Import TensorFlow and Other Libraries</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tensorflow.keras <span class="keyword">import</span> layers</span><br><span class="line"><span class="keyword">from</span> tensorflow <span class="keyword">import</span> feature_column</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getcwd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br></pre></td></tr></table></figure>
<h2 id="use-pandas-to-create-a-dataframe">Use Pandas to Create a Dataframe</h2>
<p><a target="_blank" rel="noopener" href="https://pandas.pydata.org/">Pandas</a> is a Python library with many helpful utilities for loading and working with structured data. We will use Pandas to download the dataset and load it into a dataframe.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filePath = <span class="string">f&quot;<span class="subst">&#123;getcwd()&#125;</span>/../tmp2/heart.csv&quot;</span></span><br><span class="line">dataframe = pd.read_csv(filePath)</span><br><span class="line">dataframe.head()</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
age
</th>
<th>
sex
</th>
<th>
cp
</th>
<th>
trestbps
</th>
<th>
chol
</th>
<th>
fbs
</th>
<th>
restecg
</th>
<th>
thalach
</th>
<th>
exang
</th>
<th>
oldpeak
</th>
<th>
slope
</th>
<th>
ca
</th>
<th>
thal
</th>
<th>
target
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
63
</td>
<td>
1
</td>
<td>
1
</td>
<td>
145
</td>
<td>
233
</td>
<td>
1
</td>
<td>
2
</td>
<td>
150
</td>
<td>
0
</td>
<td>
2.3
</td>
<td>
3
</td>
<td>
0
</td>
<td>
fixed
</td>
<td>
0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
67
</td>
<td>
1
</td>
<td>
4
</td>
<td>
160
</td>
<td>
286
</td>
<td>
0
</td>
<td>
2
</td>
<td>
108
</td>
<td>
1
</td>
<td>
1.5
</td>
<td>
2
</td>
<td>
3
</td>
<td>
normal
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2
</th>
<td>
67
</td>
<td>
1
</td>
<td>
4
</td>
<td>
120
</td>
<td>
229
</td>
<td>
0
</td>
<td>
2
</td>
<td>
129
</td>
<td>
1
</td>
<td>
2.6
</td>
<td>
2
</td>
<td>
2
</td>
<td>
reversible
</td>
<td>
0
</td>
</tr>
<tr>
<th>
3
</th>
<td>
37
</td>
<td>
1
</td>
<td>
3
</td>
<td>
130
</td>
<td>
250
</td>
<td>
0
</td>
<td>
0
</td>
<td>
187
</td>
<td>
0
</td>
<td>
3.5
</td>
<td>
3
</td>
<td>
0
</td>
<td>
normal
</td>
<td>
0
</td>
</tr>
<tr>
<th>
4
</th>
<td>
41
</td>
<td>
0
</td>
<td>
2
</td>
<td>
130
</td>
<td>
204
</td>
<td>
0
</td>
<td>
2
</td>
<td>
172
</td>
<td>
0
</td>
<td>
1.4
</td>
<td>
1
</td>
<td>
0
</td>
<td>
normal
</td>
<td>
0
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="split-the-dataframe-into-train-validation-and-test-sets">Split the Dataframe Into Train, Validation, and Test Sets</h2>
<p>The dataset we downloaded was a single CSV file. We will split this into train, validation, and test sets.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train, test = train_test_split(dataframe, test_size=<span class="number">0.2</span>)</span><br><span class="line">train, val = train_test_split(train, test_size=<span class="number">0.2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(train), <span class="string">&#x27;train examples&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(val), <span class="string">&#x27;validation examples&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(test), <span class="string">&#x27;test examples&#x27;</span>)</span><br></pre></td></tr></table></figure>
<pre><code>193 train examples
49 validation examples
61 test examples</code></pre>
<h2 id="create-an-input-pipeline-using-tf.data">Create an Input Pipeline Using <code>tf.data</code></h2>
<p>Next, we will wrap the dataframes with <a target="_blank" rel="noopener" href="https://www.tensorflow.org/guide/datasets">tf.data</a>. This will enable us to use feature columns as a bridge to map from the columns in the Pandas dataframe to features used to train the model. If we were working with a very large CSV file (so large that it does not fit into memory), we would use tf.data to read it from disk directly.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: A utility method to create a tf.data dataset from a Pandas Dataframe.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">df_to_dataset</span>(<span class="params">dataframe, shuffle=<span class="literal">True</span>, batch_size=<span class="number">32</span></span>):</span></span><br><span class="line">    dataframe = dataframe.copy()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Use Pandas dataframe&#x27;s pop method to get the list of targets.</span></span><br><span class="line">    labels = dataframe[<span class="string">&quot;target&quot;</span>].values</span><br><span class="line">    dataframe.drop(<span class="string">&quot;target&quot;</span>, axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Create a tf.data.Dataset from the dataframe and labels.</span></span><br><span class="line">    ds = tf.data.Dataset.from_tensor_slices((<span class="built_in">dict</span>(dataframe),labels))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> shuffle:</span><br><span class="line">        <span class="comment"># Shuffle dataset.</span></span><br><span class="line">        ds = ds.shuffle(<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Batch dataset with specified batch_size parameter.</span></span><br><span class="line">    ds = ds.batch(batch_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ds</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">5</span> <span class="comment"># A small batch sized is used for demonstration purposes</span></span><br><span class="line">train_ds = df_to_dataset(train, batch_size=batch_size)</span><br><span class="line">val_ds = df_to_dataset(val, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br><span class="line">test_ds = df_to_dataset(test, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br></pre></td></tr></table></figure>
<h2 id="understand-the-input-pipeline">Understand the Input Pipeline</h2>
<p>Now that we have created the input pipeline, let's call it to see the format of the data it returns. We have used a small batch size to keep the output readable.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> feature_batch, label_batch <span class="keyword">in</span> train_ds.take(<span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Every feature:&#x27;</span>, <span class="built_in">list</span>(feature_batch.keys()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;A batch of ages:&#x27;</span>, feature_batch[<span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;A batch of targets:&#x27;</span>, label_batch )</span><br></pre></td></tr></table></figure>
<pre><code>Every feature: [&#39;age&#39;, &#39;sex&#39;, &#39;cp&#39;, &#39;trestbps&#39;, &#39;chol&#39;, &#39;fbs&#39;, &#39;restecg&#39;, &#39;thalach&#39;, &#39;exang&#39;, &#39;oldpeak&#39;, &#39;slope&#39;, &#39;ca&#39;, &#39;thal&#39;]
A batch of ages: tf.Tensor([51 63 64 58 57], shape=(5,), dtype=int32)
A batch of targets: tf.Tensor([0 1 0 0 0], shape=(5,), dtype=int64)</code></pre>
<p>We can see that the dataset returns a dictionary of column names (from the dataframe) that map to column values from rows in the dataframe.</p>
<h2 id="create-several-types-of-feature-columns">Create Several Types of Feature Columns</h2>
<p>TensorFlow provides many types of feature columns. In this section, we will create several types of feature columns, and demonstrate how they transform a column from the dataframe.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Try to demonstrate several types of feature columns by getting an example.</span></span><br><span class="line">example_batch = <span class="built_in">next</span>(<span class="built_in">iter</span>(train_ds))[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A utility method to create a feature column and to transform a batch of data.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo</span>(<span class="params">feature_column</span>):</span></span><br><span class="line">    feature_layer = layers.DenseFeatures(feature_column, dtype=<span class="string">&#x27;float64&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(feature_layer(example_batch).numpy())</span><br></pre></td></tr></table></figure>
<h3 id="numeric-columns">Numeric Columns</h3>
<p>The output of a feature column becomes the input to the model (using the demo function defined above, we will be able to see exactly how each column from the dataframe is transformed). A <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/numeric_column">numeric column</a> is the simplest type of column. It is used to represent real valued features.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a numeric feature column out of &#x27;age&#x27; and demo it.</span></span><br><span class="line">age = tf.feature_column.numeric_column(<span class="string">&quot;age&quot;</span>)</span><br><span class="line"></span><br><span class="line">demo(age)</span><br></pre></td></tr></table></figure>
<pre><code>[[51.]
 [58.]
 [63.]
 [64.]
 [60.]]</code></pre>
<p>In the heart disease dataset, most columns from the dataframe are numeric.</p>
<h3 id="bucketized-columns">Bucketized Columns</h3>
<p>Often, you don't want to feed a number directly into the model, but instead split its value into different categories based on numerical ranges. Consider raw data that represents a person's age. Instead of representing age as a numeric column, we could split the age into several buckets using a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/bucketized_column">bucketized column</a>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a bucketized feature column out of &#x27;age&#x27; with</span></span><br><span class="line"><span class="comment"># the following boundaries and demo it.</span></span><br><span class="line">boundaries = [<span class="number">18</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">45</span>, <span class="number">50</span>, <span class="number">55</span>, <span class="number">60</span>, <span class="number">65</span>]</span><br><span class="line"></span><br><span class="line">age_buckets = tf.feature_column.bucketized_column(age, boundaries = boundaries)</span><br><span class="line"></span><br><span class="line">demo(age_buckets)</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0.]]</code></pre>
<p>Notice the one-hot values above describe which age range each row matches.</p>
<h3 id="categorical-columns">Categorical Columns</h3>
<p>In this dataset, thal is represented as a string (e.g. 'fixed', 'normal', or 'reversible'). We cannot feed strings directly to a model. Instead, we must first map them to numeric values. The categorical vocabulary columns provide a way to represent strings as a one-hot vector (much like you have seen above with age buckets).</p>
<p><strong>Note</strong>: You will probably see some warning messages when running some of the code cell below. These warnings have to do with software updates and should not cause any errors or prevent your code from running.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a categorical vocabulary column out of the</span></span><br><span class="line"><span class="comment"># above mentioned categories with the key specified as &#x27;thal&#x27;.</span></span><br><span class="line">thal = tf.feature_column.categorical_column_with_vocabulary_list(</span><br><span class="line">      <span class="string">&#x27;thal&#x27;</span>, [<span class="string">&#x27;fixed&#x27;</span>, <span class="string">&#x27;normal&#x27;</span>, <span class="string">&#x27;reversible&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># EXERCISE: Create an indicator column out of the created categorical column.</span></span><br><span class="line">thal_one_hot = tf.feature_column.indicator_column(thal)</span><br><span class="line"></span><br><span class="line">demo(thal_one_hot)</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 1. 0.]
 [0. 1. 0.]
 [0. 0. 1.]
 [0. 0. 1.]
 [0. 1. 0.]]</code></pre>
<p>The vocabulary can be passed as a list using <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/categorical_column_with_vocabulary_list">categorical_column_with_vocabulary_list</a>, or loaded from a file using <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/categorical_column_with_vocabulary_file">categorical_column_with_vocabulary_file</a>.</p>
<h3 id="embedding-columns">Embedding Columns</h3>
<p>Suppose instead of having just a few possible strings, we have thousands (or more) values per category. For a number of reasons, as the number of categories grow large, it becomes infeasible to train a neural network using one-hot encodings. We can use an embedding column to overcome this limitation. Instead of representing the data as a one-hot vector of many dimensions, an <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/embedding_column">embedding column</a> represents that data as a lower-dimensional, dense vector in which each cell can contain any number, not just 0 or 1. You can tune the size of the embedding with the <code>dimension</code> parameter.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create an embedding column out of the categorical</span></span><br><span class="line"><span class="comment"># vocabulary you just created (thal). Set the size of the </span></span><br><span class="line"><span class="comment"># embedding to 8, by using the dimension parameter.</span></span><br><span class="line"></span><br><span class="line">thal_embedding = tf.feature_column.embedding_column(thal, dimension=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">demo(thal_embedding)</span><br></pre></td></tr></table></figure>
<pre><code>[[-1.4254066e-01 -1.0374661e-01  3.4352791e-01 -3.3996427e-01
  -3.2193713e-02 -1.8381193e-01 -1.8051244e-01  3.2638407e-01]
 [-1.4254066e-01 -1.0374661e-01  3.4352791e-01 -3.3996427e-01
  -3.2193713e-02 -1.8381193e-01 -1.8051244e-01  3.2638407e-01]
 [-6.5549983e-05  2.7680036e-01  4.1849682e-01  5.3418136e-01
  -1.6281548e-01  2.5406811e-01  8.8969752e-02  1.8004593e-01]
 [-6.5549983e-05  2.7680036e-01  4.1849682e-01  5.3418136e-01
  -1.6281548e-01  2.5406811e-01  8.8969752e-02  1.8004593e-01]
 [-1.4254066e-01 -1.0374661e-01  3.4352791e-01 -3.3996427e-01
  -3.2193713e-02 -1.8381193e-01 -1.8051244e-01  3.2638407e-01]]</code></pre>
<h3 id="hashed-feature-columns">Hashed Feature Columns</h3>
<p>Another way to represent a categorical column with a large number of values is to use a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column/categorical_column_with_hash_bucket">categorical_column_with_hash_bucket</a>. This feature column calculates a hash value of the input, then selects one of the <code>hash_bucket_size</code> buckets to encode a string. When using this column, you do not need to provide the vocabulary, and you can choose to make the number of hash buckets significantly smaller than the number of actual categories to save space.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a hashed feature column with &#x27;thal&#x27; as the key and </span></span><br><span class="line"><span class="comment"># 1000 hash buckets.</span></span><br><span class="line">thal_hashed = tf.feature_column.categorical_column_with_hash_bucket(</span><br><span class="line">      <span class="string">&#x27;thal&#x27;</span>, hash_bucket_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">demo(feature_column.indicator_column(thal_hashed))</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]]</code></pre>
<h3 id="crossed-feature-columns">Crossed Feature Columns</h3>
<p>Combining features into a single feature, better known as <a target="_blank" rel="noopener" href="https://developers.google.com/machine-learning/glossary/#feature_cross">feature crosses</a>, enables a model to learn separate weights for each combination of features. Here, we will create a new feature that is the cross of age and thal. Note that <code>crossed_column</code> does not build the full table of all possible combinations (which could be very large). Instead, it is backed by a <code>hashed_column</code>, so you can choose how large the table is.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a crossed column using the bucketized column (age_buckets),</span></span><br><span class="line"><span class="comment"># the categorical vocabulary column (thal) previously created, and 1000 hash buckets.</span></span><br><span class="line">crossed_feature = tf.feature_column.crossed_column([age_buckets, thal], hash_bucket_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">demo(feature_column.indicator_column(crossed_feature))</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]
 [0. 0. 0. ... 0. 0. 0.]]</code></pre>
<h2 id="choose-which-columns-to-use">Choose Which Columns to Use</h2>
<p>We have seen how to use several types of feature columns. Now we will use them to train a model. The goal of this exercise is to show you the complete code needed to work with feature columns. We have selected a few columns to train our model below arbitrarily.</p>
<p>If your aim is to build an accurate model, try a larger dataset of your own, and think carefully about which features are the most meaningful to include, and how they should be represented.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataframe.dtypes</span><br></pre></td></tr></table></figure>
<pre><code>age           int64
sex           int64
cp            int64
trestbps      int64
chol          int64
fbs           int64
restecg       int64
thalach       int64
exang         int64
oldpeak     float64
slope         int64
ca            int64
thal         object
target        int64
dtype: object</code></pre>
<p>You can use the above list of column datatypes to map the appropriate feature column to every column in the dataframe.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Fill in the missing code below</span></span><br><span class="line">feature_columns = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Numeric Cols.</span></span><br><span class="line"><span class="comment"># Create a list of numeric columns. Use the following list of columns</span></span><br><span class="line"><span class="comment"># that have a numeric datatype: [&#x27;age&#x27;, &#x27;trestbps&#x27;, &#x27;chol&#x27;, &#x27;thalach&#x27;, &#x27;oldpeak&#x27;, &#x27;slope&#x27;, &#x27;ca&#x27;].</span></span><br><span class="line">numeric_columns = [<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;trestbps&#x27;</span>, <span class="string">&#x27;chol&#x27;</span>, <span class="string">&#x27;thalach&#x27;</span>, <span class="string">&#x27;oldpeak&#x27;</span>, <span class="string">&#x27;slope&#x27;</span>, <span class="string">&#x27;ca&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> header <span class="keyword">in</span> numeric_columns:</span><br><span class="line">    <span class="comment"># Create a numeric feature column  out of the header.</span></span><br><span class="line">    numeric_feature_column = tf.feature_column.numeric_column(header)</span><br><span class="line">    </span><br><span class="line">    feature_columns.append(numeric_feature_column)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bucketized Cols.</span></span><br><span class="line"><span class="comment"># Create a bucketized feature column out of the age column (numeric column)</span></span><br><span class="line"><span class="comment"># that you&#x27;ve already created. Use the following boundaries:</span></span><br><span class="line"><span class="comment"># [18, 25, 30, 35, 40, 45, 50, 55, 60, 65]</span></span><br><span class="line">age_buckets = tf.feature_column.bucketized_column(age, boundaries = [<span class="number">18</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">45</span>, <span class="number">50</span>, <span class="number">55</span>, <span class="number">60</span>, <span class="number">65</span>] )</span><br><span class="line"></span><br><span class="line">feature_columns.append(age_buckets)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Indicator Cols.</span></span><br><span class="line"><span class="comment"># Create a categorical vocabulary column out of the categories</span></span><br><span class="line"><span class="comment"># [&#x27;fixed&#x27;, &#x27;normal&#x27;, &#x27;reversible&#x27;] with the key specified as &#x27;thal&#x27;.</span></span><br><span class="line">thal = feature_column.categorical_column_with_vocabulary_list(</span><br><span class="line">      <span class="string">&#x27;thal&#x27;</span>, [<span class="string">&#x27;fixed&#x27;</span>, <span class="string">&#x27;normal&#x27;</span>, <span class="string">&#x27;reversible&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an indicator column out of the created thal categorical column</span></span><br><span class="line">thal_one_hot = feature_column.indicator_column(thal)</span><br><span class="line"></span><br><span class="line">feature_columns.append(thal_one_hot)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Embedding Cols.</span></span><br><span class="line"><span class="comment"># Create an embedding column out of the categorical vocabulary you</span></span><br><span class="line"><span class="comment"># just created (thal). Set the size of the embedding to 8, by using</span></span><br><span class="line"><span class="comment"># the dimension parameter.</span></span><br><span class="line">thal_embedding = tf.feature_column.embedding_column(thal, dimension=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">feature_columns.append(thal_embedding)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Crossed Cols.</span></span><br><span class="line"><span class="comment"># Create a crossed column using the bucketized column (age_buckets),</span></span><br><span class="line"><span class="comment"># the categorical vocabulary column (thal) previously created, and 1000 hash buckets.</span></span><br><span class="line">crossed_feature = feature_column.crossed_column([age_buckets, thal], hash_bucket_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an indicator column out of the crossed column created above to one-hot encode it.</span></span><br><span class="line">crossed_feature = feature_column.indicator_column(crossed_feature)</span><br><span class="line"></span><br><span class="line">feature_columns.append(crossed_feature)</span><br></pre></td></tr></table></figure>
<h3 id="create-a-feature-layer">Create a Feature Layer</h3>
<p>Now that we have defined our feature columns, we will use a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/keras/layers/DenseFeatures">DenseFeatures</a> layer to input them to our Keras model.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Create a Keras DenseFeatures layer and pass the feature_columns you just created.</span></span><br><span class="line">feature_layer = tf.keras.layers.DenseFeatures(feature_columns)</span><br></pre></td></tr></table></figure>
<p>Earlier, we used a small batch size to demonstrate how feature columns worked. We create a new input pipeline with a larger batch size.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">32</span></span><br><span class="line">train_ds = df_to_dataset(train, batch_size=batch_size)</span><br><span class="line">val_ds = df_to_dataset(val, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br><span class="line">test_ds = df_to_dataset(test, shuffle=<span class="literal">False</span>, batch_size=batch_size)</span><br></pre></td></tr></table></figure>
<h2 id="create-compile-and-train-the-model">Create, Compile, and Train the Model</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">model = tf.keras.Sequential([</span><br><span class="line">        feature_layer,</span><br><span class="line">        layers.Dense(<span class="number">128</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">        layers.Dense(<span class="number">128</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">        layers.Dense(<span class="number">1</span>, activation=<span class="string">&#x27;sigmoid&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>,</span><br><span class="line">              loss=<span class="string">&#x27;binary_crossentropy&#x27;</span>,</span><br><span class="line">              metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line"></span><br><span class="line">model.fit(train_ds,</span><br><span class="line">          validation_data=val_ds,</span><br><span class="line">          epochs=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<pre><code>......
7/7 [==============================] - 0s 45ms/step - loss: 0.2225 - accuracy: 0.8912 - val_loss: 0.6998 - val_accuracy: 0.6939
Epoch 98/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2089 - accuracy: 0.9067 - val_loss: 0.6846 - val_accuracy: 0.7143
Epoch 99/100
7/7 [==============================] - 0s 44ms/step - loss: 0.2043 - accuracy: 0.8964 - val_loss: 0.7292 - val_accuracy: 0.7347
Epoch 100/100
7/7 [==============================] - 0s 55ms/step - loss: 0.2008 - accuracy: 0.9016 - val_loss: 0.7064 - val_accuracy: 0.7143





&lt;tensorflow.python.keras.callbacks.History at 0x7f33184937b8&gt;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loss, accuracy = model.evaluate(test_ds)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy&quot;</span>, accuracy)</span><br></pre></td></tr></table></figure>
<pre><code>2/2 [==============================] - 1s 329ms/step - loss: 0.5511 - accuracy: 0.8197
Accuracy 0.8196721</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Use-Tensorflow-Lite-to-do-Inference-on-Raspberry-Pi/2020/02/17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Use-Tensorflow-Lite-to-do-Inference-on-Raspberry-Pi/2020/02/17/" class="post-title-link" itemprop="url">Use Tensorflow Lite to do Inference on Raspberry Pi</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-17 20:30:15" itemprop="dateCreated datePublished" datetime="2020-02-17T20:30:15+08:00">2020-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-08 02:06:46" itemprop="dateModified" datetime="2020-04-08T02:06:46+08:00">2020-04-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI-Workflow/" itemprop="url" rel="index"><span itemprop="name">AI Workflow</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI-Workflow/Deployment/" itemprop="url" rel="index"><span itemprop="name">Deployment</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Use-Tensorflow-Lite-to-do-Inference-on-Raspberry-Pi/2020/02/17/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Use-Tensorflow-Lite-to-do-Inference-on-Raspberry-Pi/2020/02/17/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="image-classification-in-raspberry-pi">Image Classification in Raspberry Pi</h1>
<h2 id="building-tensorflow-lite">Building TensorFlow Lite</h2>
<h3 id="cross-compile">Cross Compile</h3>
<p>We recommend cross-compiling the TensorFlow Raspbian package. Cross-compilation is using a different platform to build the package than deploy to. Instead of using the Raspberry Pi's limited RAM and comparatively slow processor, it's easier to build TensorFlow on a more powerful host machine running Linux, macOS, or Windows. You can see detailed instructions <a target="_blank" rel="noopener" href="https://www.tensorflow.org/install/source_rpi">here</a>.</p>
<h2 id="install-just-the-tensorflow-lite-interpreter">Install just the TensorFlow Lite interpreter</h2>
<p>To quickly start executing TensorFlow Lite models with Python, you can install just the TensorFlow Lite interpreter, instead of all TensorFlow packages.</p>
<p>This interpreter-only package is a fraction the size of the full TensorFlow package and includes the bare minimum code required to run inferences with TensorFlow Liteit includes only the <code>tf.lite.Interpreter</code> Python class. This small package is ideal when all you want to do is execute .tflite models and avoid wasting disk space with the large TensorFlow library.</p>
<h3 id="install-from-pip">Install from pip</h3>
<p>To install just the interpreter, download the appropriate Python wheel for your system from the following <a target="_blank" rel="noopener" href="https://www.tensorflow.org/lite/guide/python">link</a>, and then install it with the <code>pip install</code> command.</p>
<p>For example, if you're setting up a Raspberry Pi Model B (using Raspbian Stretch, which has Python 3.5), install the Python wheel as follows (after you click to download the <code>.whl</code> file in the provided link):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tflite_runtime-1.14.0-cp35-cp35m-linux_armv7l.whl</span><br></pre></td></tr></table></figure>
<h3 id="running-inference">Running inference</h3>
<p>So instead of importing Interpreter from the tensorflow module, you need to import it from tflite_runtime. <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from tflite_runtime.interpreter import Interpreter</span><br></pre></td></tr></table></figure></p>
<h2 id="additional-notes">Additional notes</h2>
<p>In case you have built TensorFlow from source, you need to import the Interpreter as follows: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from tensorflow.lite.python.interpreter import Interpreter </span><br></pre></td></tr></table></figure></p>
<h2 id="inference-on-pi">Inference on Pi</h2>
<p>To get started, download the pretrained model along with its label file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/download.tensorflow.org/models/tflite/mobilenet_v1_1.0_224_quant_and_labels.zip</span><br><span class="line">unzip mobilenet_v1_1.0_224_quant_and_labels</span><br></pre></td></tr></table></figure>
<h3 id="prerequisites">Prerequisites</h3>
<p>To install the Python dependencies, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install numpy</span><br><span class="line">pip install Pillow</span><br></pre></td></tr></table></figure>
<p>Next, to run the code on Raspberry Pi, use <code>classify.py</code> as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 classify.py --filename dog.jpg --model_path mobilenet_v1_1.0_224_quant.tflite --label_path labels_mobilenet_quant_v1_224.txt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>classify.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tflite_runtime.interpreter <span class="keyword">import</span> Interpreter</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Image Classification&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--filename&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;Specify the filename&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--model_path&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;Specify the model path&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--label_path&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;Specify the label map&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--top_k&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;How many top results&#x27;</span>, default=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">filename = args.filename</span><br><span class="line">model_path = args.model_path </span><br><span class="line">label_path = args.label_path </span><br><span class="line">top_k_results = args.top_k</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(label_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    labels = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">str</span>.strip, f.readlines()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load TFLite model and allocate tensors</span></span><br><span class="line">interpreter = Interpreter(model_path=model_path)</span><br><span class="line">interpreter.allocate_tensors()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get input and output tensors.</span></span><br><span class="line">input_details = interpreter.get_input_details()</span><br><span class="line">output_details = interpreter.get_output_details()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read image</span></span><br><span class="line">img = Image.<span class="built_in">open</span>(filename).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get input size</span></span><br><span class="line">input_shape = input_details[<span class="number">0</span>][<span class="string">&#x27;shape&#x27;</span>]</span><br><span class="line">size = input_shape[:<span class="number">2</span>] <span class="keyword">if</span> <span class="built_in">len</span>(input_shape) == <span class="number">3</span> <span class="keyword">else</span> input_shape[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Preprocess image</span></span><br><span class="line">img = img.resize(size)</span><br><span class="line">img = np.array(img)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add a batch dimension</span></span><br><span class="line">input_data = np.expand_dims(img, axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Point the data to be used for testing and run the interpreter</span></span><br><span class="line">interpreter.set_tensor(input_details[<span class="number">0</span>][<span class="string">&#x27;index&#x27;</span>], input_data)</span><br><span class="line">interpreter.invoke()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Obtain results and map them to the classes</span></span><br><span class="line">predictions = interpreter.get_tensor(output_details[<span class="number">0</span>][<span class="string">&#x27;index&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get indices of the top k results</span></span><br><span class="line">top_k_indices = np.argsort(predictions)[::-<span class="number">1</span>][:top_k_results]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(top_k_results):</span><br><span class="line">    <span class="built_in">print</span>(labels[top_k_indices[i]], predictions[top_k_indices[i]] / <span class="number">255.0</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Tensorflow-Lite-Model-Converter/2020/02/16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tensorflow-Lite-Model-Converter/2020/02/16/" class="post-title-link" itemprop="url">Tensorflow Lite: Model Converter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-16 04:39:52" itemprop="dateCreated datePublished" datetime="2020-02-16T04:39:52+08:00">2020-02-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-08 02:07:01" itemprop="dateModified" datetime="2020-04-08T02:07:01+08:00">2020-04-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI-Workflow/" itemprop="url" rel="index"><span itemprop="name">AI Workflow</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI-Workflow/Deployment/" itemprop="url" rel="index"><span itemprop="name">Deployment</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tensorflow-Lite-Model-Converter/2020/02/16/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tensorflow-Lite-Model-Converter/2020/02/16/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="copyright-2018-the-tensorflow-authors.">Copyright 2018 The TensorFlow Authors.</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ATTENTION: Please do not alter any of the provided code in the exercise. Only add your own code where indicated</span></span><br><span class="line"><span class="comment"># ATTENTION: Please do not add or remove any cells in the exercise. The grader will check specific cells based on the cell position.</span></span><br><span class="line"><span class="comment"># ATTENTION: Please use the provided epoch values when training.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br></pre></td></tr></table></figure>
<h1 id="train-your-own-model-and-convert-it-to-tflite">Train Your Own Model and Convert It to TFLite</h1>
<p>This notebook uses the <a target="_blank" rel="noopener" href="https://github.com/zalandoresearch/fashion-mnist">Fashion MNIST</a> dataset which contains 70,000 grayscale images in 10 categories. The images show individual articles of clothing at low resolution (28 by 28 pixels), as seen here:</p>
<table>
<tr>
<td>
<img src="https://tensorflow.org/images/fashion-mnist-sprite.png"
         alt="Fashion MNIST sprite"  width="600">
</td>
</tr>
<tr>
<td align="center">
<b>Figure 1.</b> <a target="_blank" rel="noopener" href="https://github.com/zalandoresearch/fashion-mnist">Fashion-MNIST samples</a> (by Zalando, MIT License).<br/>
</td>
</tr>
</table>
<p>Fashion MNIST is intended as a drop-in replacement for the classic <a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/">MNIST</a> datasetoften used as the "Hello, World" of machine learning programs for computer vision. The MNIST dataset contains images of handwritten digits (0, 1, 2, etc.) in a format identical to that of the articles of clothing we'll use here.</p>
<p>This uses Fashion MNIST for variety, and because it's a slightly more challenging problem than regular MNIST. Both datasets are relatively small and are used to verify that an algorithm works as expected. They're good starting points to test and debug code.</p>
<p>We will use 60,000 images to train the network and 10,000 images to evaluate how accurately the network learned to classify images. You can access the Fashion MNIST directly from TensorFlow. Import and load the Fashion MNIST data directly from TensorFlow:</p>
<h1 id="setup">Setup</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TensorFlow</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># TensorFlow Datsets</span></span><br><span class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</span><br><span class="line">tfds.disable_progress_bar()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Helper Libraries</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pathlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getcwd</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\u2022 Using TensorFlow Version:&#x27;</span>, tf.__version__)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\u2022 GPU Device Found.&#x27;</span> <span class="keyword">if</span> tf.test.is_gpu_available() <span class="keyword">else</span> <span class="string">&#x27;\u2022 GPU Device Not Found. Running on CPU&#x27;</span>)</span><br></pre></td></tr></table></figure>
<pre><code> Using TensorFlow Version: 2.0.0
 GPU Device Found.</code></pre>
<h1 id="download-fashion-mnist-dataset">Download Fashion MNIST Dataset</h1>
<p>We will use TensorFlow Datasets to load the Fashion MNIST dataset.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">splits = tfds.Split.ALL.subsplit(weighted=(<span class="number">80</span>, <span class="number">10</span>, <span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">filePath = <span class="string">f&quot;<span class="subst">&#123;getcwd()&#125;</span>/../tmp2/&quot;</span></span><br><span class="line">splits, info = tfds.load(<span class="string">&#x27;fashion_mnist&#x27;</span>, with_info=<span class="literal">True</span>, as_supervised=<span class="literal">True</span>, split=splits, data_dir=filePath)</span><br><span class="line"></span><br><span class="line">(train_examples, validation_examples, test_examples) = splits</span><br><span class="line"></span><br><span class="line">num_examples = info.splits[<span class="string">&#x27;train&#x27;</span>].num_examples</span><br><span class="line">num_classes = info.features[<span class="string">&#x27;label&#x27;</span>].num_classes</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sample = <span class="built_in">next</span>(<span class="built_in">iter</span>(train_examples))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sample[<span class="number">0</span>].shape</span><br></pre></td></tr></table></figure>
<pre><code>TensorShape([28, 28, 1])</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sample[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<pre><code>&lt;tf.Tensor: id=490, shape=(), dtype=int64, numpy=6&gt;</code></pre>
<p>The class names are not included with the dataset, so we will specify them here.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class_names = [<span class="string">&#x27;T-shirt_top&#x27;</span>, <span class="string">&#x27;Trouser&#x27;</span>, <span class="string">&#x27;Pullover&#x27;</span>, <span class="string">&#x27;Dress&#x27;</span>, <span class="string">&#x27;Coat&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;Sandal&#x27;</span>, <span class="string">&#x27;Shirt&#x27;</span>, <span class="string">&#x27;Sneaker&#x27;</span>, <span class="string">&#x27;Bag&#x27;</span>, <span class="string">&#x27;Ankle boot&#x27;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a labels.txt file with the class names</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;labels.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&#x27;\n&#x27;</span>.join(class_names))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The images in the dataset are 28 by 28 pixels.</span></span><br><span class="line">IMG_SIZE = <span class="number">28</span></span><br></pre></td></tr></table></figure>
<h1 id="preprocessing-data">Preprocessing Data</h1>
<h2 id="preprocess">Preprocess</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Write a function to normalize the images.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_example</span>(<span class="params">image, label</span>):</span></span><br><span class="line">    <span class="comment"># Cast image to float32</span></span><br><span class="line">    image = tf.cast(image, tf.float32)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Normalize the image in the range [0, 1]</span></span><br><span class="line">    image = image / <span class="number">255.0</span></span><br><span class="line">    </span><br><span class="line">    label = tf.one_hot(label, num_classes)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> image, label</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Specify the batch size</span></span><br><span class="line">BATCH_SIZE = <span class="number">256</span></span><br></pre></td></tr></table></figure>
<h2 id="create-datasets-from-images-and-labels">Create Datasets From Images and Labels</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create Datasets</span></span><br><span class="line">train_batches = train_examples.cache().shuffle(num_examples//<span class="number">4</span>).batch(BATCH_SIZE).<span class="built_in">map</span>(format_example).prefetch(<span class="number">1</span>)</span><br><span class="line">validation_batches = validation_examples.cache().batch(BATCH_SIZE).<span class="built_in">map</span>(format_example)</span><br><span class="line">test_batches = test_examples.<span class="built_in">map</span>(format_example).batch(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">batch_sample = <span class="built_in">next</span>(<span class="built_in">iter</span>(train_batches))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tf.squeeze(batch_sample[<span class="number">0</span>][<span class="number">0</span>]).numpy()</span><br></pre></td></tr></table></figure>
<pre><code>array([[0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.16078432, 0.47843137, 0.3019608 ,
        0.10588235, 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.46666667, 0.8509804 , 0.6666667 ,
        0.63529414, 0.11372549, 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.13333334, 0.74509805, 0.98039216, 0.8117647 , 0.6156863 ,
        0.62352943, 0.87058824, 0.40392157, 0.01568628, 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.4509804 , 0.99215686, 0.87058824, 0.7019608 , 0.57254905,
        0.6666667 , 0.56078434, 0.49411765, 0.47058824, 0.11372549,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.3372549 , 0.8666667 , 0.76862746, 0.7019608 , 0.6901961 ,
        0.57254905, 0.33333334, 0.49411765, 0.6039216 , 0.24705882,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.40392157, 0.78431374, 0.65882355, 0.7137255 , 0.58431375,
        0.39215687, 0.29411766, 0.78431374, 0.39215687, 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.6039216 , 0.8       , 0.73333335, 0.78431374, 0.49019608,
        0.3137255 , 0.38039216, 0.17254902, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.26666668, 0.9019608 , 0.8117647 , 0.8392157 , 0.49019608,
        0.38039216, 0.37254903, 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.7058824 , 0.58431375, 0.49019608, 0.4       ,
        0.4509804 , 0.23529412, 0.        , 0.00392157, 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.3137255 , 0.7176471 , 0.42745098, 0.42352942, 0.38039216,
        0.45882353, 0.15686275, 0.        , 0.        , 0.01176471,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.62352943, 0.7372549 , 0.44705883, 0.40392157, 0.38039216,
        0.44705883, 0.23921569, 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.85882354, 0.78039217, 0.44705883, 0.4117647 , 0.4       ,
        0.4117647 , 0.4117647 , 0.03529412, 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.67058825, 0.8666667 , 0.54509807, 0.48235294, 0.43529412,
        0.4117647 , 0.4       , 0.1254902 , 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.37254903, 0.9137255 , 0.6039216 , 0.54509807, 0.5058824 ,
        0.53333336, 0.5372549 , 0.11372549, 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.4       , 0.89411765, 0.5254902 , 0.54509807, 0.5176471 ,
        0.57254905, 0.65882355, 0.16078432, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.53333336, 0.8901961 , 0.5254902 , 0.54509807, 0.5176471 ,
        0.57254905, 0.56078434, 0.16078432, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.64705884, 0.8784314 , 0.49411765, 0.56078434, 0.48235294,
        0.6039216 , 0.6156863 , 0.14509805, 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.8156863 , 0.8784314 , 0.5058824 , 0.6156863 , 0.48235294,
        0.6039216 , 0.6039216 , 0.16078432, 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.9372549 , 0.84705883, 0.49411765, 0.6784314 , 0.45882353,
        0.68235296, 0.627451  , 0.21176471, 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.95686275, 0.8392157 , 0.49411765, 0.7176471 , 0.47058824,
        0.68235296, 0.6156863 , 0.23529412, 0.        , 0.00392157,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.06666667,
        0.9019608 , 0.8392157 , 0.47058824, 0.7490196 , 0.49019608,
        0.75686276, 0.6039216 , 0.27058825, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.14509805,
        0.8352941 , 0.8784314 , 0.46666667, 0.78039217, 0.54901963,
        0.78039217, 0.57254905, 0.30588236, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.22352941,
        0.8235294 , 0.99215686, 0.47058824, 0.8       , 0.58431375,
        0.7921569 , 0.54901963, 0.34901962, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.28235295,
        0.75686276, 1.        , 0.48235294, 0.76862746, 0.6156863 ,
        0.7921569 , 0.5568628 , 0.36078432, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.36862746,
        0.73333335, 0.8901961 , 0.5058824 , 0.7254902 , 0.68235296,
        0.77254903, 0.54509807, 0.4117647 , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.49019608,
        0.6901961 , 0.90588236, 0.5372549 , 0.6392157 , 0.7058824 ,
        0.85882354, 0.56078434, 0.42745098, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.627451  ,
        0.78039217, 0.9137255 , 0.827451  , 0.6509804 , 0.91764706,
        0.69411767, 0.6       , 0.48235294, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ],
       [0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.04705882, 0.34901962, 0.24705882, 0.11764706,
        0.18431373, 0.77254903, 0.29411766, 0.        , 0.        ,
        0.        , 0.        , 0.        , 0.        , 0.        ,
        0.        , 0.        , 0.        ]], dtype=float32)</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">batch_sample[<span class="number">1</span>][<span class="number">0</span>].numpy().argmax()</span><br></pre></td></tr></table></figure>
<pre><code>3</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_batch</span>(<span class="params">x,y,shape = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    input: </span></span><br><span class="line"><span class="string">        x(Tensor[num_images, rows, columns]): images tensor</span></span><br><span class="line"><span class="string">        y(array): labels</span></span><br><span class="line"><span class="string">        shape(tuple): (rows,col) </span></span><br><span class="line"><span class="string">    output:</span></span><br><span class="line"><span class="string">        grid of smaple images</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shape:</span><br><span class="line">        shape = (<span class="built_in">int</span>(x.shape[<span class="number">0</span>]**<span class="number">0.5</span>), <span class="built_in">int</span>(x.shape[<span class="number">0</span>]**<span class="number">0.5</span>))</span><br><span class="line"></span><br><span class="line">    fig, axs = plt.subplots(nrows= shape[<span class="number">0</span>], ncols=shape[<span class="number">1</span>], figsize = (<span class="number">12</span>,<span class="number">8</span>))</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> axs:</span><br><span class="line">        <span class="keyword">for</span> ax <span class="keyword">in</span> row:</span><br><span class="line">            ax.imshow(tf.squeeze(x[index]).numpy())</span><br><span class="line">            ax.set_xlabel(class_names[y[index].numpy().argmax()])</span><br><span class="line">            index+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># plt.subplots_adjust(wspace = 0.2, hspace = 0.5) </span></span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show_batch(batch_sample[<span class="number">0</span>],batch_sample[<span class="number">1</span>], (<span class="number">4</span>,<span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<figure>
<img src="output_24_0.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<h1 id="building-the-model">Building the Model</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Model: &quot;sequential&quot;</span><br><span class="line">_________________________________________________________________</span><br><span class="line">Layer (type)                 Output Shape              Param #   </span><br><span class="line">=================================================================</span><br><span class="line">conv2d (Conv2D)              (None, 26, 26, 16)        160       </span><br><span class="line">_________________________________________________________________</span><br><span class="line">max_pooling2d (MaxPooling2D) (None, 13, 13, 16)        0         </span><br><span class="line">_________________________________________________________________</span><br><span class="line">conv2d_1 (Conv2D)            (None, 11, 11, 32)        4640      </span><br><span class="line">_________________________________________________________________</span><br><span class="line">flatten (Flatten)            (None, 3872)              0         </span><br><span class="line">_________________________________________________________________</span><br><span class="line">dense (Dense)                (None, 64)                247872    </span><br><span class="line">_________________________________________________________________</span><br><span class="line">dense_1 (Dense)              (None, 10)                650       </span><br><span class="line">=================================================================</span><br><span class="line">Total params: 253,322</span><br><span class="line">Trainable params: 253,322</span><br><span class="line">Non-trainable params: 0</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Build and compile the model shown in the previous cell.</span></span><br><span class="line"></span><br><span class="line">model = tf.keras.Sequential([</span><br><span class="line">    <span class="comment"># Set the input shape to (28, 28, 1), kernel size=3, filters=16 and use ReLU activation,</span></span><br><span class="line">    tf.keras.layers.Conv2D(input_shape = (<span class="number">28</span>,<span class="number">28</span>,<span class="number">1</span>), kernel_size=<span class="number">3</span>, filters=<span class="number">16</span>,activation = <span class="string">&quot;relu&quot;</span>),</span><br><span class="line">      </span><br><span class="line">    tf.keras.layers.MaxPooling2D(),</span><br><span class="line">      </span><br><span class="line">    <span class="comment"># Set the number of filters to 32, kernel size to 3 and use ReLU activation </span></span><br><span class="line">    tf.keras.layers.Conv2D(filters=<span class="number">32</span>, kernel_size=<span class="number">3</span>, activation=<span class="string">&quot;relu&quot;</span>),</span><br><span class="line">      </span><br><span class="line">    <span class="comment"># Flatten the output layer to 1 dimension</span></span><br><span class="line">    tf.keras.layers.Flatten(),</span><br><span class="line">      </span><br><span class="line">    <span class="comment"># Add a fully connected layer with 64 hidden units and ReLU activation</span></span><br><span class="line">    tf.keras.layers.Dense(units=<span class="number">64</span>, activation=<span class="string">&quot;relu&quot;</span>),</span><br><span class="line">      </span><br><span class="line">    <span class="comment"># Attach a final softmax classification head</span></span><br><span class="line">    tf.keras.layers.Dense(units = num_classes, activation=<span class="string">&quot;softmax&quot;</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the appropriate loss function and use accuracy as your metric</span></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>,</span><br><span class="line">              loss= tf.keras.losses.CategoricalCrossentropy(),</span><br><span class="line">              metrics=[<span class="string">&#x27;accuracy&#x27;</span>] )</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.summary()</span><br></pre></td></tr></table></figure>
<pre><code>Model: &quot;sequential_1&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_2 (Conv2D)            (None, 26, 26, 16)        160       
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 13, 13, 16)        0         
_________________________________________________________________
conv2d_3 (Conv2D)            (None, 11, 11, 32)        4640      
_________________________________________________________________
flatten_1 (Flatten)          (None, 3872)              0         
_________________________________________________________________
dense_2 (Dense)              (None, 64)                247872    
_________________________________________________________________
dense_3 (Dense)              (None, 10)                650       
=================================================================
Total params: 253,322
Trainable params: 253,322
Non-trainable params: 0
_________________________________________________________________</code></pre>
<h2 id="train">Train</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history = model.fit(train_batches, epochs=<span class="number">10</span>, validation_data=validation_batches)</span><br></pre></td></tr></table></figure>
<pre><code>Epoch 1/10
219/219 [==============================] - 148s 675ms/step - loss: 0.5912 - accuracy: 0.7919 - val_loss: 0.0000e+00 - val_accuracy: 0.0000e+00
Epoch 2/10
219/219 [==============================] - 4s 20ms/step - loss: 0.3837 - accuracy: 0.8648 - val_loss: 0.3390 - val_accuracy: 0.8796
Epoch 3/10
219/219 [==============================] - 4s 20ms/step - loss: 0.3319 - accuracy: 0.8819 - val_loss: 0.3046 - val_accuracy: 0.8914
Epoch 4/10
219/219 [==============================] - 4s 20ms/step - loss: 0.3014 - accuracy: 0.8925 - val_loss: 0.2903 - val_accuracy: 0.8957
Epoch 5/10
219/219 [==============================] - 4s 20ms/step - loss: 0.2805 - accuracy: 0.8993 - val_loss: 0.2841 - val_accuracy: 0.9011
Epoch 6/10
219/219 [==============================] - 4s 20ms/step - loss: 0.2602 - accuracy: 0.9054 - val_loss: 0.2777 - val_accuracy: 0.9009
Epoch 7/10
219/219 [==============================] - 4s 20ms/step - loss: 0.2477 - accuracy: 0.9101 - val_loss: 0.2548 - val_accuracy: 0.9091
Epoch 8/10
219/219 [==============================] - 4s 20ms/step - loss: 0.2351 - accuracy: 0.9144 - val_loss: 0.2703 - val_accuracy: 0.9000
Epoch 9/10
219/219 [==============================] - 4s 20ms/step - loss: 0.2209 - accuracy: 0.9198 - val_loss: 0.2462 - val_accuracy: 0.9126
Epoch 10/10
219/219 [==============================] - 4s 20ms/step - loss: 0.2108 - accuracy: 0.9243 - val_loss: 0.2566 - val_accuracy: 0.9089</code></pre>
<h1 id="exporting-to-tflite">Exporting to TFLite</h1>
<p>You will now save the model to TFLite. We should note, that you will probably see some warning messages when running the code below. These warnings have to do with software updates and should not cause any errors or prevent your code from running.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Use the tf.saved_model API to save your model in the SavedModel format. </span></span><br><span class="line">export_dir = <span class="string">&#x27;saved_model/1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YOUR CODE HERE</span></span><br><span class="line">tf.saved_model.save(model, export_dir)</span><br></pre></td></tr></table></figure>
<pre><code>WARNING:tensorflow:From /usr/local/lib/python3.6/dist-packages/tensorflow_core/python/ops/resource_variable_ops.py:1781: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.


WARNING:tensorflow:From /usr/local/lib/python3.6/dist-packages/tensorflow_core/python/ops/resource_variable_ops.py:1781: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.


INFO:tensorflow:Assets written to: saved_model/1/assets


INFO:tensorflow:Assets written to: saved_model/1/assets</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Select mode of optimization</span></span><br><span class="line">mode = <span class="string">&quot;Speed&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;Storage&#x27;</span>:</span><br><span class="line">    optimization = tf.lite.Optimize.OPTIMIZE_FOR_SIZE</span><br><span class="line"><span class="keyword">elif</span> mode == <span class="string">&#x27;Speed&#x27;</span>:</span><br><span class="line">    optimization = tf.lite.Optimize.OPTIMIZE_FOR_LATENCY</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    optimization = tf.lite.Optimize.DEFAULT</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXERCISE: Use the TFLiteConverter SavedModel API to initialize the converter</span></span><br><span class="line"></span><br><span class="line">converter = tf.lite.TFLiteConverter.from_saved_model(export_dir)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the optimzations</span></span><br><span class="line">converter.optimizations = [optimization]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke the converter to finally generate the TFLite model</span></span><br><span class="line">tflite_model = converter.convert()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tflite_model_file = pathlib.Path(<span class="string">&#x27;./model.tflite&#x27;</span>)</span><br><span class="line">tflite_model_file.write_bytes(tflite_model)</span><br></pre></td></tr></table></figure>
<pre><code>258704</code></pre>
<h1 id="test-the-model-with-tflite-interpreter">Test the Model with TFLite Interpreter</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Load TFLite model and allocate tensors.</span></span><br><span class="line">interpreter = tf.lite.Interpreter(model_content=tflite_model)</span><br><span class="line">interpreter.allocate_tensors()</span><br><span class="line"></span><br><span class="line">input_index = interpreter.get_input_details()[<span class="number">0</span>][<span class="string">&quot;index&quot;</span>]</span><br><span class="line">output_index = interpreter.get_output_details()[<span class="number">0</span>][<span class="string">&quot;index&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gather results for the randomly sampled test images</span></span><br><span class="line">predictions = []</span><br><span class="line">test_labels = []</span><br><span class="line">test_images = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> img, label <span class="keyword">in</span> test_batches.take(<span class="number">50</span>):</span><br><span class="line">    interpreter.set_tensor(input_index, img)</span><br><span class="line">    interpreter.invoke()</span><br><span class="line">    predictions.append(interpreter.get_tensor(output_index))</span><br><span class="line">    test_labels.append(label[<span class="number">0</span>])</span><br><span class="line">    test_images.append(np.array(img))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class_names</span><br></pre></td></tr></table></figure>
<pre><code>[&#39;T-shirt_top&#39;,
 &#39;Trouser&#39;,
 &#39;Pullover&#39;,
 &#39;Dress&#39;,
 &#39;Coat&#39;,
 &#39;Sandal&#39;,
 &#39;Shirt&#39;,
 &#39;Sneaker&#39;,
 &#39;Bag&#39;,
 &#39;Ankle boot&#39;]</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Utilities functions for plotting</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_image</span>(<span class="params">i, predictions_array, true_label, img</span>):</span></span><br><span class="line">    predictions_array, true_label, img = predictions_array[i], true_label[i], img[i]</span><br><span class="line">    plt.grid(<span class="literal">False</span>)</span><br><span class="line">    plt.xticks([])</span><br><span class="line">    plt.yticks([])</span><br><span class="line">    </span><br><span class="line">    img = np.squeeze(img)</span><br><span class="line">    </span><br><span class="line">    plt.imshow(img, cmap=plt.cm.binary)</span><br><span class="line">    </span><br><span class="line">    predicted_label = np.argmax(predictions_array)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#     print(predicted_label)</span></span><br><span class="line"><span class="comment">#     print(true_label.numpy().argmax())</span></span><br><span class="line">    <span class="keyword">if</span> predicted_label == true_label.numpy().argmax():</span><br><span class="line">        color = <span class="string">&#x27;green&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        color = <span class="string">&#x27;red&#x27;</span></span><br><span class="line">        </span><br><span class="line">    plt.xlabel(<span class="string">&quot;&#123;&#125; &#123;:2.0f&#125;% (&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(class_names[predicted_label],</span><br><span class="line">                                         <span class="number">100</span>*np.<span class="built_in">max</span>(predictions_array),</span><br><span class="line">                                         class_names[true_label.numpy().argmax()]),</span><br><span class="line">                                         color=color)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_value_array</span>(<span class="params">i, predictions_array, true_label</span>):</span></span><br><span class="line">    predictions_array, true_label = predictions_array[i], true_label[i]</span><br><span class="line">    plt.grid(<span class="literal">False</span>)</span><br><span class="line">    plt.xticks(<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line">    plt.yticks([])</span><br><span class="line">    thisplot = plt.bar(<span class="built_in">range</span>(<span class="number">10</span>), predictions_array[<span class="number">0</span>], color=<span class="string">&quot;#777777&quot;</span>)</span><br><span class="line">    plt.ylim([<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">    predicted_label = np.argmax(predictions_array[<span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line">    thisplot[predicted_label].set_color(<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">    thisplot[true_label.numpy().argmax()].set_color(<span class="string">&#x27;blue&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Visualize the outputs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Select index of image to display. Minimum index value is 1 and max index value is 50. </span></span><br><span class="line">index = <span class="number">49</span> </span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">6</span>,<span class="number">3</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">plot_image(index, predictions, test_labels, test_images)</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">plot_value_array(index, predictions, test_labels)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<figure>
<img src="output_41_0.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<h2 id="other-comfiguration-example">Other Comfiguration example</h2>
<h3 id="post-training-quantization">Post-Training Quantization</h3>
<p>The simplest form of post-training quantization quantizes weights from floating point to 8-bits of precision. This technique is enabled as an option in the TensorFlow Lite converter. At inference, weights are converted from 8-bits of precision to floating point and computed using floating-point kernels. This conversion is done once and cached to reduce latency.</p>
<p>To further improve latency, hybrid operators dynamically quantize activations to 8-bits and perform computations with 8-bit weights and activations. This optimization provides latencies close to fully fixed-point inference. However, the outputs are still stored using floating point, so that the speedup with hybrid ops is less than a full fixed-point computation.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">converter.optimizations = [tf.lite.Optimize.DEFAULT]</span><br></pre></td></tr></table></figure>
<h3 id="post-training-integer-quantization">Post-Training Integer Quantization</h3>
<p>We can get further latency improvements, reductions in peak memory usage, and access to integer only hardware accelerators by making sure all model math is quantized. To do this, we need to measure the dynamic range of activations and inputs with a representative data set. You can simply create an input data generator and provide it to our converter.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">representative_data_gen</span>():</span></span><br><span class="line">    <span class="keyword">for</span> input_value, _ <span class="keyword">in</span> test_batches.take(<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">yield</span> [input_value]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">converter.representative_dataset = representative_data_gen</span><br></pre></td></tr></table></figure>
<p>The resulting model will be fully quantized but still take float input and output for convenience.</p>
<p>Ops that do not have quantized implementations will automatically be left in floating point. This allows conversion to occur smoothly but may restrict deployment to accelerators that support float.</p>
<h3 id="full-integer-quantization">Full Integer Quantization</h3>
<p>To require the converter to only output integer operations, one can specify:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">converter.target_spec.supported_ops = [tf.lite.OpsSet.TFLITE_BUILTINS_INT8]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Promise/2020/02/13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Promise/2020/02/13/" class="post-title-link" itemprop="url">Promise</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-13 11:22:12" itemprop="dateCreated datePublished" datetime="2020-02-13T11:22:12+08:00">2020-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-14 01:07:26" itemprop="dateModified" datetime="2020-02-14T01:07:26+08:00">2020-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Programming-Language/" itemprop="url" rel="index"><span itemprop="name">Programming Language</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Programming-Language/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Promise/2020/02/13/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Promise/2020/02/13/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>concepts of Promise, Async, Await</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Promise/2020/02/13/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Introduction-to-Operating-Systems/2020/02/07/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Introduction-to-Operating-Systems/2020/02/07/" class="post-title-link" itemprop="url">Introduction to Operating Systems</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-02-07 00:29:25 / Modified: 13:43:31" itemprop="dateCreated datePublished" datetime="2020-02-07T00:29:25+08:00">2020-02-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Operating-System/" itemprop="url" rel="index"><span itemprop="name">Operating System</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Introduction-to-Operating-Systems/2020/02/07/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Introduction-to-Operating-Systems/2020/02/07/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This is the course note from Introduction to Operating Systems of Udacity</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Introduction-to-Operating-Systems/2020/02/07/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/AI-Search/2020/02/06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/AI-Search/2020/02/06/" class="post-title-link" itemprop="url">AI - Search</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-06 20:56:08" itemprop="dateCreated datePublished" datetime="2020-02-06T20:56:08+08:00">2020-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-31 15:10:56" itemprop="dateModified" datetime="2021-12-31T15:10:56+08:00">2021-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/AI-Search/2020/02/06/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/AI-Search/2020/02/06/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>CS221 course notes of Search problem in AI</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/AI-Search/2020/02/06/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/AI-Overview/2020/02/05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/AI-Overview/2020/02/05/" class="post-title-link" itemprop="url">AI - Overview</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-05 21:58:42" itemprop="dateCreated datePublished" datetime="2020-02-05T21:58:42+08:00">2020-02-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 11:41:20" itemprop="dateModified" datetime="2020-02-07T11:41:20+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/AI-Overview/2020/02/05/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/AI-Overview/2020/02/05/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Two views of AI, modeling-inference-learning paradigm, Machine Learning</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/AI-Overview/2020/02/05/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Module-Sequential-ModuleList-ModuleDict/2020/01/28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Module-Sequential-ModuleList-ModuleDict/2020/01/28/" class="post-title-link" itemprop="url">Module Sequential ModuleList ModuleDict</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-28 16:21:52" itemprop="dateCreated datePublished" datetime="2020-01-28T16:21:52+08:00">2020-01-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-31 15:41:43" itemprop="dateModified" datetime="2021-12-31T15:41:43+08:00">2021-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Artificial-Intelligence/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Module-Sequential-ModuleList-ModuleDict/2020/01/28/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Module-Sequential-ModuleList-ModuleDict/2020/01/28/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Module Sequential ModuleList ModuleDict</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Module-Sequential-ModuleList-ModuleDict/2020/01/28/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zhangruochi.com/Minimum-Spanning-Trees/2020/01/25/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ruochi Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RUOCHI.AI">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Minimum-Spanning-Trees/2020/01/25/" class="post-title-link" itemprop="url">Minimum Spanning Trees</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-25 15:56:49" itemprop="dateCreated datePublished" datetime="2020-01-25T15:56:49+08:00">2020-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-31 15:42:30" itemprop="dateModified" datetime="2021-12-31T15:42:30+08:00">2021-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Structure-and-Algorithm/" itemprop="url" rel="index"><span itemprop="name">Data Structure and Algorithm</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Minimum-Spanning-Trees/2020/01/25/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Minimum-Spanning-Trees/2020/01/25/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Minimum Spanning Trees</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Minimum-Spanning-Trees/2020/01/25/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ruochi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">268</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhangruochi" title="GitHub  https:&#x2F;&#x2F;github.com&#x2F;zhangruochi" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zrc720@gmail.com" title="E-Mail  mailto:zrc720@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.healthinformaticslab.org/" title="http:&#x2F;&#x2F;www.healthinformaticslab.org" rel="noopener" target="_blank">HILab</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.shihaizhou.com/" title="http:&#x2F;&#x2F;www.shihaizhou.com" rel="noopener" target="_blank">Rose</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/cherish_CX/" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;cherish_CX&#x2F;" rel="noopener" target="_blank">Chunxia</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019  
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ruochi Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'qW3MLcAgcX96sB6qbegeL7rP-gzGzoHsz',
      appKey     : 'GL6JvT9DgGxqYrY5Vj6bXVuv',
      placeholder: "Thank you for your reply",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
